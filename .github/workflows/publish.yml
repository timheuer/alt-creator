name: Publish Extension

on:
    push:
        branches: [main]
        paths:
            - "manifest.json"
            - "background/**"
            - "content/**"
            - "popup/**"
            - "icons/*.png"
    workflow_dispatch:

jobs:
    build:
        runs-on: ubuntu-latest
        outputs:
            version: ${{ steps.version.outputs.version }}
            version_changed: ${{ steps.check.outputs.changed }}
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 2

            - name: Get version from manifest
              id: version
              run: |
                  VERSION=$(jq -r '.version' manifest.json)
                  echo "version=$VERSION" >> $GITHUB_OUTPUT

            - name: Check if version changed
              id: check
              run: |
                  git diff HEAD~1 HEAD --quiet -- manifest.json && echo "changed=false" >> $GITHUB_OUTPUT || echo "changed=true" >> $GITHUB_OUTPUT

            - name: Create extension package
              run: |
                  mkdir -p dist
                  mkdir -p dist/icons
                  cp manifest.json dist/
                  cp -r background dist/
                  cp -r content dist/
                  cp -r popup dist/
                  cp icons/*.png dist/icons/
                  cd dist && zip -r ../extension.zip . && cd ..

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: extension-${{ steps.version.outputs.version }}
                  path: extension.zip

    release:
        needs: build
        runs-on: ubuntu-latest
        if: needs.build.outputs.version_changed == 'true' || github.event_name == 'workflow_dispatch'
        outputs:
            upload_url: ${{ steps.create_release.outputs.upload_url }}
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Download artifact
              uses: actions/download-artifact@v4
              with:
                  name: extension-${{ needs.build.outputs.version }}

            - name: Create GitHub Release
              id: create_release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: v${{ needs.build.outputs.version }}
                  name: v${{ needs.build.outputs.version }}
                  body: |
                      ## Alt Text Creator v${{ needs.build.outputs.version }}

                      ### Installation
                      - [Chrome Web Store](https://chrome.google.com/webstore/detail/${{ secrets.CHROME_EXTENSION_ID }})
                      - [Edge Add-ons](https://microsoftedge.microsoft.com/addons/detail/${{ secrets.EDGE_PRODUCT_ID }})

                      ### Manual Installation
                      Download `extension.zip` below and load it as an unpacked extension.
                  files: extension.zip
                  draft: false
                  prerelease: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    publish-chrome:
        needs: [build, release]
        runs-on: ubuntu-latest
        steps:
            - name: Download artifact
              uses: actions/download-artifact@v4
              with:
                  name: extension-${{ needs.build.outputs.version }}

            - name: Publish to Chrome Web Store
              uses: mnao305/chrome-extension-upload@v5.0.0
              with:
                  file-path: extension.zip
                  extension-id: ${{ secrets.CHROME_EXTENSION_ID }}
                  client-id: ${{ secrets.CHROME_CLIENT_ID }}
                  client-secret: ${{ secrets.CHROME_CLIENT_SECRET }}
                  refresh-token: ${{ secrets.CHROME_REFRESH_TOKEN }}
                  publish: true

    publish-edge:
        needs: [build, release]
        runs-on: ubuntu-latest
        steps:
            - name: Download artifact
              uses: actions/download-artifact@v4
              with:
                  name: extension-${{ needs.build.outputs.version }}

            - name: Publish to Edge Add-ons
              uses: nicosomb/edge-addon-action@v1.0.3
              with:
                  zip-path: extension.zip
                  product-id: ${{ secrets.EDGE_PRODUCT_ID }}
                  client-id: ${{ secrets.EDGE_CLIENT_ID }}
                  client-secret: ${{ secrets.EDGE_CLIENT_SECRET }}
                  access-token-url: ${{ secrets.EDGE_ACCESS_TOKEN_URL }}
